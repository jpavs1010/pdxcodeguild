{% load static %}

<h1 id="page_title"></h1>
<div id="map"></div>
<select id="ddl_graph">
    <option value="Access 2010">Access 2010</option>
    <option value="Access 2015">Access 2015</option>
    <option value="Diabetes 2010">Diabetes 2010</option>
    <option value="Diabetes 2013">Diabetes 2013</option>
    <option value="Obese 2008">Obese 2008</option>
    <option value="Obese 2013">Obese 2013</option>
    <option value="Grocery 2009">Grocery 2009</option>
    <option value="Grocery 2014">Grocery 2014</option>
    <option value="Supercenter 2009">Supercenter 2009</option>
    <option value="Supercenter 2014">Supercenter 2014</option>
    <option value="Convenience 2009">Convenience 2009</option>
    <option value="Convenience 2014">Convenience 2014</option>
    <option value="White 2010">Caucasian 2010</option>
    <option value="Black 2010">African American 2010</option>
    <option value="Hispanic 2010">Hispanic 2010</option>
    <option value="Asian 2010">Asian 2010</option>
    <option value="American Indian 2010">Native American 2010</option>
    <option value="Hawaiian 2010">Hawaiian 2010</option>
</select>
<button id="bt_show_graph">show</button>


<svg width="960" height="600"></svg>
<style>
    .counties {
        fill: none;
    }

    .states {
        fill: none;
        stroke: #000;
        stroke-linejoin: round;
    }
</style>

<!--<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>-->
<script src="https://d3js.org/d3.v4.min.js"></script> <!--from d3 website-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script> <!--script used in tutorial-->
<script src="https://d3js.org/topojson.v1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.1.4/js.cookie.min.js"></script>

<!--<script src="../../visualization.js"></script> tutorial uses separate document-->

<script>


//    function Dropdownfunction() {
//        document.getElementById("MyDropdown").classList.toggle("show");
//    }
//
//    window.onclick = function (event) {
//        if (!event.target.matches('.dropbtn')) {
//
//            var dropdowns = document.getElementsByClassName("dropdown-content");
//            var i;
//            for (i = 0; i < dropdowns.length; i++) {
//                var openDropdown = dropdowns[i];
//                if (openDropdown.classList.contains('show')) {
//                    openDropdown.classList.remove('show');
//                }
//            }
//        }
//    };


    var bt_show_graph = document.getElementById('bt_show_graph');
    var ddl_graph = document.getElementById('ddl_graph');
    bt_show_graph.onclick = function() {
        var selected_graph = ddl_graph.options[ddl_graph.selectedIndex].value;
        generate_graph(selected_graph);
    };


    generate_graph('access2010');



    function generate_graph(graph_name) {

        console.log("{% url 'capstone:getdata' %}?graph_name="+graph_name);



        var lower_bound = 0;
        var upper_bound = 100;
        var title = document.getElementById('page_title').innerHTML = graph_name;
        var legend_title = graph_name;


        function draw_key(svg) {

            // range for the tick-marks
            var x = d3.scaleLinear()
                .domain([1, 10])
                .rangeRound([0, 260]);
            var w = 350, h = 120;
            svg.append("rect")
                .attr("width", w - 100)
                .attr("height", h - 100)
                .style("fill", "url(#gradient)")
                .style('stroke', 'black')
                .style('stroke-width', '1')
                .attr("transform", "translate(600,40)");


            // add the key to the SVG
            var g = svg.append("g")
                .attr("class", "key")
                .attr("transform", "translate(600,40)");

            var legend = svg.append("defs")
                .append("svg:linearGradient")
                .attr("id", "gradient")
                .attr("x1", "0%")
                .attr("x2", "100%")
                .attr("spreadMethod", "pad");
            legend.append("stop")
                .attr("offset", "0%")
                .attr("stop-color", '#0000ff')
                .attr("stop-opacity", 1);
            legend.append("stop")
                .attr("offset", "100%")
                .attr("stop-color", '#ffffff')
                .attr("stop-opacity", 1);
            var y = d3.scaleLinear().range([300, 0]).domain([1, 100]);
    //        var yAxis = d3.axisLeft().scale(y).orient("right");
    //        key.append("g").attr("class","y axis").attr("transform", "translate(41,10)").call(yAxis).append("text").attr("transform", "rotate(-90)").attr("y", 30).attr("dy", ".71em").style("text-anchor", "end").text("axis title");


            // DRAW THE TITLE OVER THE KEY
            g.append("text")
                .attr("class", "caption")
                .attr("x", 0)
                .attr("y", -6)
                .attr("fill", "#000")
                .attr("text-anchor", "start")
                .attr("font-weight", "bold")
                .text(legend_title);

            //DRAW NUMBERS BELOW KEY
            g.call(d3.axisBottom(x)
                .tickSize(20)
                .tickFormat(function (d) {
                    return ((upper_bound - lower_bound) / 10) * d + "%";
                })
                .tickValues(d3.range(2, 10)))
                .select(".domain")
                .remove();
        }

        var svg = d3.select("svg"),
            width = +svg.attr("width"),
            height = +svg.attr("height");

        var access = d3.map();

        var path = d3.geoPath();

        // ADD COLOR SCALE
        var color = d3.scaleLinear()
            .domain([lower_bound, upper_bound])
            //.domain(d3.range(2, 88))
            //.domain([0.02, 0.04, 0.06, 0.08, 0.10])
            //.range(["#f2f0f7", "#dadaeb", "#bcbddc", "#9e9ac8", "#756bb1", "#54278f"]);
            //.range(['#f7fbff','#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#08519c','#08306b']);
            .range(['#0000ff', '#ffffff']);

        draw_key(svg);

        //ADD JSON FILES FOR MAP AND DATA
        d3.queue()
            .defer(d3.json, "https://d3js.org/us-10m.v1.json")
            .defer(d3.json, "{% url 'capstone:getdata' %}?graph_name="+graph_name)
            .defer(d3.json, "{% url 'capstone:getmetadata' %}?graph_name="+graph_name)
            .await(ready);


        // DRAWS THE MAP
        function ready(error, us, data, metadata) {
            if (error) throw error;

            console.log(metadata);

            data = data.all_data;
            for (var i = 0; i < data.length; i++) {
                access.set(data[i].county_id, +data[i].data_value);
            }

            svg.append("g")
                .attr("class", "counties")
                .selectAll("path")
                .data(topojson.feature(us, us.objects.counties).features)
                .enter().append("path")
                .attr("fill", function (d) {
                    //console.log(d);
                    d.data_value = access.get(d.id);
                    if (typeof d.data_value == 'undefined') {
                        return '#000000'
                    }
                    return color(d.data_value);


                })
                .attr("d", path)
                .append("title")
                .text(function (d) {
                    if (typeof d.data_value != 'undefined') {
                        return d.data_value.toFixed(2) + "%" + ' ' + d.county + ',' + d.state;
                    } else {
                        return 'No Data';
                    }
                });

            // DRAWS STATE LINES
            svg.append("path")
                .datum(topojson.mesh(us, us.objects.states, function (a, b) {
                    return a !== b;
                }))
                .attr("class", "states")
                .attr("d", path);
        }
    }
</script>